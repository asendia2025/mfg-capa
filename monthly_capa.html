<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Capacity Trend</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    
    <script src="ct_pages/capa_data.js"></script>

    <style>
        /* [전역 스타일 설정] */
        body { font-family: 'Varela Round', sans-serif; }
        
        /* [스크롤바 커스텀] 얇고 깔끔한 디자인 적용 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #d4d4d8; border-radius: 20px; }
        
        /* [테이블 스타일] 셀 및 헤더 디자인 */
        .table-cell { text-align: center; font-size: 11px; padding: 10px 4px; border-bottom: 1px solid #f4f4f5; color: #3f3f46; }
        .table-header { font-size: 10px; font-weight: bold; color: #71717a; text-transform: uppercase; background-color: #fafafa; position: sticky; top: 0; white-space: nowrap; border-bottom: 2px solid #e4e4e7; }
        
        /* [툴팁 스타일] 헤더에 마우스 오버시 Note 내용 표시 */
        .header-tooltip { position: relative; cursor: help; }
        .header-tooltip:hover::after {
            content: attr(data-tip); 
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background-color: #27272a; color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 11px; white-space: pre-wrap; width: max-content; max-width: 250px; z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-top: 5px; pointer-events: none; font-weight: normal; text-transform: none;
        }
    </style>
</head>
<body class="bg-white h-screen flex flex-col p-6 overflow-hidden relative">

    <div class="flex items-center justify-between mb-6 shrink-0">
        <h1 class="text-2xl font-bold text-zinc-900 flex items-center gap-2">
            <span class="w-2 h-8 bg-blue-500 rounded-full"></span>
            Monthly Capacity Trend
        </h1>
        
        <div class="flex gap-4 items-center">
            <div class="flex items-center bg-zinc-100 rounded-md border border-zinc-200 shadow-sm h-8">
                <button onclick="changeLabelSize(-2)" class="w-8 h-full flex items-center justify-center hover:bg-white rounded-l-md text-zinc-500 transition-colors active:text-blue-600" title="글자 작게">
                    <i data-lucide="minus" class="w-3 h-3"></i>
                </button>
                <div class="w-px h-3 bg-zinc-300"></div> <button onclick="changeLabelSize(2)" class="w-8 h-full flex items-center justify-center hover:bg-white rounded-r-md text-zinc-500 transition-colors active:text-blue-600" title="글자 크게">
                    <i data-lucide="plus" class="w-3 h-3"></i>
                </button>
            </div>

            <div class="flex gap-2 p-1 rounded-full bg-zinc-100/50 border border-zinc-200 shadow-inner h-10 items-center">
                <button onclick="renderDashboard('rfg')" id="tab-rfg" class="px-5 py-1.5 rounded-full text-xs font-bold transition-all shadow-sm bg-white text-blue-600 border border-zinc-100">RF Generator</button>
                <button onclick="renderDashboard('rfm')" id="tab-rfm" class="px-5 py-1.5 rounded-full text-xs font-bold text-zinc-400 hover:text-zinc-600 transition-all">RF Matcher</button>
                <button onclick="renderDashboard('evc')" id="tab-evc" class="px-5 py-1.5 rounded-full text-xs font-bold text-zinc-400 hover:text-zinc-600 transition-all">EVC</button>
            </div>
        </div>
    </div>

    <div class="h-[45vh] w-full bg-white border border-zinc-200 rounded-xl p-4 mb-6 relative shrink-0 shadow-sm">
        <canvas id="trendChart"></canvas>
    </div>

    <div class="flex-1 overflow-auto bg-white border border-zinc-200 rounded-xl relative shadow-sm">
        <table class="w-full border-collapse">
            <thead class="bg-zinc-50 sticky top-0 z-10">
                <tr id="table-head-row"></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        // 아이콘 초기화
        lucide.createIcons();
        
        // 전역 변수 설정
        let chartInstance = null; // 차트 객체 저장용
        let currentModule = 'rfg'; // 현재 선택된 모듈 (기본값: rfg)
        
        // ★ [설정 1] 라벨 초기 크기 설정 (기존 30 -> 24로 축소)
        let currentLabelSize = 24; 

        // [함수] 대시보드 렌더링 (탭 클릭 시 호출)
        function renderDashboard(module) {
            currentModule = module;
            
            // 탭 스타일 업데이트 (활성/비활성 처리)
            ['rfg', 'rfm', 'evc'].forEach(m => {
                const btn = document.getElementById(`tab-${m}`);
                if (m === module) {
                    // 활성 상태 스타일
                    btn.classList.remove('text-zinc-400');
                    btn.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'border', 'border-zinc-100');
                } else {
                    // 비활성 상태 스타일
                    btn.classList.add('text-zinc-400');
                    btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'border', 'border-zinc-100');
                }
            });

            // 데이터 파일 로드 확인
            if(typeof CAPA_DB === 'undefined') {
                alert("Data file (capa_data.js) not found. Please check ct_pages folder.");
                return;
            }

            const data = CAPA_DB[module] || [];
            updateUI(data); // 차트 및 테이블 업데이트 실행
        }

        // [함수] UI 업데이트 (차트 + 테이블)
        function updateUI(data) {
            const labels = data.map(d => d.month);
            // 값이 0이면 차트에서 끊기도록 null로 변환
            const cleanData = (val) => (val === 0 || val === undefined ? null : val);

            // ★ [기능] Y축 최대값 자동 계산 (최대값 + 20)
            const maxCapacity = Math.max(...data.map(d => d.cap_mon || 0));
            const yAxisMax = Math.ceil(maxCapacity + 20);

            // 1. 차트 렌더링
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (chartInstance) chartInstance.destroy(); // 기존 차트 삭제 후 재생성

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            // [데이터셋 1] 월간 Capacity (라인 그래프)
                            label: 'Monthly Capacity',
                            data: data.map(d => cleanData(d.cap_mon)),
                            type: 'line', 
                            borderColor: '#2563eb', backgroundColor: '#2563eb', // 파란색
                            borderWidth: 2, 
                            yAxisID: 'y', // 왼쪽 Y축 사용
                            tension: 0.3, // 곡선 처리
                            spanGaps: false, // 데이터 끊김 허용
                            datalabels: { 
                                align: 'top', anchor: 'start', color: '#2563eb', 
                                font: { weight: 'bold', size: currentLabelSize } // ★ 동적 폰트 사이즈 적용
                            }
                        },
                        {
                            // [데이터셋 2] 조립 인원 (막대 그래프)
                            label: 'Assembly Staff',
                            data: data.map(d => cleanData(d.assy)),
                            backgroundColor: '#a1a1aa', // 회색
                            yAxisID: 'y1', // 오른쪽 Y축 사용
                            datalabels: { 
                                color: 'white', 
                                // ★ [설정 2] Headcount 폰트 비율 확대 (0.4 -> 0.65)
                                font: { size: Math.max(10, currentLabelSize * 0.65) } 
                            }
                        },
                        {
                            // [데이터셋 3] 테스트 인원 (막대 그래프)
                            label: 'Testing Staff',
                            data: data.map(d => cleanData(d.test)),
                            backgroundColor: '#52525b', // 진한 회색
                            yAxisID: 'y1', // 오른쪽 Y축 사용
                            datalabels: { 
                                color: 'white', 
                                // ★ [설정 2] Headcount 폰트 비율 확대 (0.4 -> 0.65)
                                font: { size: Math.max(10, currentLabelSize * 0.65) } 
                            }
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { usePointStyle: true, font: {family:"'Varela Round'", size: 11} } }, 
                        datalabels: { display: true } 
                    },
                    scales: {
                        y: { 
                            // [왼쪽 Y축] Capacity
                            type: 'linear', display: true, position: 'left',
                            max: yAxisMax, // ★ 계산된 최대값 적용
                            title: {display:true, text:'Capacity (Units)', font:{family:"'Varela Round'"}}, 
                            grid: {display:false, drawBorder: false} 
                        },
                        y1: { 
                            // [오른쪽 Y축] Headcount (사람 수)
                            type: 'linear', display: true, position: 'right', min:0, max:15, 
                            title: {display:true, text:'Headcount', font:{family:"'Varela Round'"}}, 
                            grid: {drawOnChartArea:false, drawBorder: false} 
                        },
                        x: { grid: {display: false} } // X축 그리드 숨김
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 2. 테이블 렌더링
            const thead = document.getElementById('table-head-row');
            const tbody = document.getElementById('table-body');
            
            // 테이블 헤더 생성
            let headerHtml = `<th class="table-header px-4 py-3 border-b border-zinc-200 w-24 text-left">Item</th>`;
            data.forEach(d => {
                const note = d.note ? d.note.trim() : "";
                // Note가 있으면 툴팁 클래스 추가
                const tooltipAttr = note ? `class="table-header px-4 py-3 border-b border-zinc-200 text-center header-tooltip text-blue-600" data-tip="${note}"` : `class="table-header px-4 py-3 border-b border-zinc-200 text-center"`;
                // Note가 있으면 별표(*) 표시
                const labelContent = note ? `${d.month} <span class="text-[9px] align-top text-blue-500">*</span>` : d.month;
                headerHtml += `<th ${tooltipAttr}>${labelContent}</th>`;
            });
            thead.innerHTML = headerHtml;

            // 테이블 본문 생성 (표시할 항목 정의)
            const keys = [
                { key: 'pm', label: 'Production Management Staff' },
                { key: 'pt', label: 'Production Technology Staff' },
                { key: 'assy', label: 'Assembly Staff' },
                { key: 'test', label: 'Testing Staff' },
                { key: 'tb', label: '# of Test Bench' },
                { key: 'total', label: 'Total Staff', bold: true },
                { key: 'cap_mon', label: 'Monthly Capacity', bold: true, color: 'text-blue-600' },
                { key: 'cap_year', label: 'Yearly Capacity' }
            ];

            let rowsHtml = '';
            keys.forEach(k => {
                let row = `<tr><td class="px-4 py-2 text-xs font-bold text-zinc-500 border-b border-zinc-100 bg-zinc-50/30">${k.label}</td>`;
                data.forEach(d => {
                    const style = k.bold ? 'font-bold' : ''; 
                    const color = k.color ? k.color : 'text-zinc-600';
                    const cellClass = `class="table-cell ${style} ${color}"`;
                    let val = d[k.key] !== undefined ? d[k.key] : '';
                    // 0인 경우 '-'로 표시 (PM, PT 제외)
                    if (val === 0 && k.key !== 'pm' && k.key !== 'pt') val = '-';
                    row += `<td ${cellClass}>${val}</td>`;
                });
                row += '</tr>';
                rowsHtml += row;
            });
            tbody.innerHTML = rowsHtml;
        }

        // ★ [기능] 라벨 크기 조절 함수
        function changeLabelSize(delta) {
            currentLabelSize += delta;
            // 크기 제한 설정 (최소 8px ~ 최대 60px)
            if(currentLabelSize < 8) currentLabelSize = 8;
            if(currentLabelSize > 60) currentLabelSize = 60;
            
            // 차트 다시 그리기 (변경된 크기 적용)
            const data = CAPA_DB[currentModule] || [];
            updateUI(data);
        }

        // 초기 실행 (기본 RFG 대시보드 로드)
        renderDashboard('rfg');
    </script>
</body>
</html>
